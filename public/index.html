<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå</h1>

    <div class="controls">
      <div class="api-info">
        <label>API URL:</label>
        <input id="apiUrlInput" type="text" />
        <button id="saveApiUrlBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>

      <div class="reset-area">
        <button id="resetBtn" class="danger">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà)</button>
      </div>
    </div>

    <p class="hint">
      * ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ API URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô<br />
      ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    </p>

    <div id="statusMessage" class="status-message"></div>

    <!-- ‡πÇ‡∏ã‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå -->
    <div class="bus-layout">
      <div class="bus-front">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ñ / ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</div>
      <div id="seatsContainer" class="seats-container">
        <!-- ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
      </div>
    </div>
  </div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
  const DEFAULT_API_URL = 'http://localhost:3000';
  const API_URL_KEY = 'busCheckApiUrl';

  function getApiUrl() {
    return localStorage.getItem(API_URL_KEY) || DEFAULT_API_URL;
  }

  function setApiUrl(url) {
    localStorage.setItem(API_URL_KEY, url);
  }

  const apiUrlInput = document.getElementById('apiUrlInput');
  const saveApiUrlBtn = document.getElementById('saveApiUrlBtn');
  const resetBtn = document.getElementById('resetBtn');
  const seatsContainer = document.getElementById('seatsContainer');
  const statusMessage = document.getElementById('statusMessage');

  apiUrlInput.value = getApiUrl();

  let socket = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö socket ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

  // ---------- socket.io ----------
  function setupSocket() {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
    if (socket) {
      socket.disconnect();
      socket = null;
    }

    const baseUrl = getApiUrl();

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend (port 3000 ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á)
    socket = io(baseUrl, {
      transports: ['websocket', 'polling']
    });

    socket.on('connect', () => {
      console.log('socket connected', socket.id);
      showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    });

    socket.on('disconnect', () => {
      console.log('socket disconnected');
      showStatus('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ socket ‡∏´‡∏•‡∏∏‡∏î', 'error');
    });

    // üëâ ‡πÄ‡∏°‡∏∑‡πà‡∏≠ server ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤
    socket.on('seatsUpdated', (seats) => {
      renderSeats(seats);
    });
  }

  saveApiUrlBtn.addEventListener('click', () => {
    const url = apiUrlInput.value.trim();
    if (!url) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API URL');
      return;
    }
    setApiUrl(url);
    showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API URL ‡πÅ‡∏•‡πâ‡∏ß', 'success');
    loadSeatsFromServer(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
    setupSocket();         // ‡∏ï‡πà‡∏≠ socket ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ URL ‡πÉ‡∏´‡∏°‡πà
  });

  resetBtn.addEventListener('click', async () => {
    const confirmReset = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');
    if (!confirmReset) return;

    try {
      const res = await fetch(getApiUrl() + '/api/seats/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        throw new Error('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }

      showStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á loadSeatsFromServer() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ server ‡∏à‡∏∞ emit seatsUpdated ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
    } catch (err) {
      console.error(err);
      showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API URL', 'error');
    }
  });

  function showStatus(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = 'status-message ' + type;

    if (message) {
      setTimeout(() => {
        statusMessage.textContent = '';
        statusMessage.className = 'status-message';
      }, 4000);
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏ú‡πà‡∏≤‡∏ô HTTP ‡∏õ‡∏Å‡∏ï‡∏¥
  async function loadSeatsFromServer() {
    try {
      const res = await fetch(getApiUrl() + '/api/seats');
      if (!res.ok) {
        throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
      const seats = await res.json();
      renderSeats(seats);
    } catch (err) {
      console.error(err);
      showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API URL', 'error');
    }
  }

  function createSeatElement(seat) {
    const seatDiv = document.createElement('div');
    seatDiv.classList.add('seat');
    if (seat.checked) seatDiv.classList.add('checked');

    const numberSpan = document.createElement('div');
    numberSpan.classList.add('seat-number');
    numberSpan.textContent = '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ' + seat.number;

    const nameSpan = document.createElement('div');
    nameSpan.classList.add('seat-name');
    nameSpan.textContent = seat.checked
      ? '‡∏ä‡∏∑‡πà‡∏≠: ' + (seat.name || '-')
      : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠';

    const btn = document.createElement('button');
    btn.classList.add('seat-btn');
    btn.textContent = seat.checked ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠' : '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠';

    btn.addEventListener('click', () => {
      handleSeatClick(seat);
    });

    seatDiv.appendChild(numberSpan);
    seatDiv.appendChild(nameSpan);
    seatDiv.appendChild(btn);

    return seatDiv;
  }

  function renderSeats(seats) {
    seatsContainer.innerHTML = '';

    seats.sort((a, b) => a.number - b.number);

    const seatsPerRow = 4; // ‡∏ã‡πâ‡∏≤‡∏¢ 2 ‡∏Ç‡∏ß‡∏≤ 2

    for (let i = 0; i < seats.length; i += seatsPerRow) {
      const row = document.createElement('div');
      row.classList.add('seat-row');

      const leftSide = document.createElement('div');
      leftSide.classList.add('seat-side', 'left-side');

      const rightSide = document.createElement('div');
      rightSide.classList.add('seat-side', 'right-side');

      for (let j = i; j < i + 2 && j < seats.length; j++) {
        leftSide.appendChild(createSeatElement(seats[j]));
      }

      for (let j = i + 2; j < i + 4 && j < seats.length; j++) {
        rightSide.appendChild(createSeatElement(seats[j]));
      }

      const aisle = document.createElement('div');
      aisle.classList.add('aisle');

      row.appendChild(leftSide);
      row.appendChild(aisle);
      row.appendChild(rightSide);

      seatsContainer.appendChild(row);
    }
  }

  async function handleSeatClick(seat) {
    if (!seat.checked) {
      const name = prompt(
        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ' + seat.number + ':'
      );
      if (name === null) return;
      const trimmedName = name.trim();
      if (!trimmedName) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
        return;
      }

      try {
        await updateSeat(seat.number, { checked: true, name: trimmedName });
        showStatus('‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á ‡∏£‡∏≠ event seatsUpdated ‡∏à‡∏≤‡∏Å server
      } catch (err) {
        console.error(err);
        showStatus('‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    } else {
      const confirmUncheck = confirm(
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ' + seat.number + ' ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?'
      );
      if (!confirmUncheck) return;

      try {
        await updateSeat(seat.number, { checked: false, name: '' });
        showStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
      } catch (err) {
        console.error(err);
        showStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }
  }

  async function updateSeat(number, data) {
    const res = await fetch(getApiUrl() + '/api/seats/' + number + '/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      throw new Error('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    return res.json();
  }

  // ---------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ----------
  loadSeatsFromServer();
  setupSocket();
</script>

